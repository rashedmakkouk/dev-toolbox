"use strict";(self.webpackChunk_rashedmakkouk_dev_toolbox=self.webpackChunk_rashedmakkouk_dev_toolbox||[]).push([[9078],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return d}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)n=l[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},f=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,l=e.originalType,s=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),f=c(n),d=r,m=f["".concat(s,".").concat(d)]||f[d]||u[d]||l;return n?a.createElement(m,o(o({ref:t},p),{},{components:n})):a.createElement(m,o({ref:t},p))}));function d(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=n.length,o=new Array(l);o[0]=f;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var c=2;c<l;c++)o[c]=n[c];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}f.displayName="MDXCreateElement"},5765:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return d},frontMatter:function(){return i},metadata:function(){return c},toc:function(){return u}});var a=n(7462),r=n(3366),l=(n(7294),n(3905)),o=["components"],i={title:"Setup Self-hosted Instance",sidebar_label:"Setup Self-hosted Instance"},s=void 0,c={unversionedId:"how-to/gitlab/setup-self-hosted-instance",id:"how-to/gitlab/setup-self-hosted-instance",title:"Setup Self-hosted Instance",description:"Commands",source:"@site/content/how-to/gitlab/setup-self-hosted-instance.md",sourceDirName:"how-to/gitlab",slug:"/how-to/gitlab/setup-self-hosted-instance",permalink:"/dev-toolbox/how-to/gitlab/setup-self-hosted-instance",draft:!1,editUrl:"https://github.com/rashedmakkouk/dev-toolbox/edit/main/content/how-to/gitlab/setup-self-hosted-instance.md",tags:[],version:"current",lastUpdatedBy:"Rashed Makkouk",lastUpdatedAt:1654710696,formattedLastUpdatedAt:"6/8/2022",frontMatter:{title:"Setup Self-hosted Instance",sidebar_label:"Setup Self-hosted Instance"},sidebar:"sidebar",previous:{title:"Restore Backup Archive",permalink:"/dev-toolbox/how-to/gitlab/restore-backup-archive"},next:{title:"Upgrade Packaged Postgresql Server",permalink:"/dev-toolbox/how-to/gitlab/upgrade-packaged-postgresql-server"}},p={},u=[{value:"Commands",id:"commands",level:2},{value:"Installation",id:"installation",level:2},{value:"OS",id:"os",level:3},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Installer",id:"installer",level:3},{value:"SSH files",id:"ssh-files",level:3},{value:"CONFIG TEMPLATE",id:"config-template",level:2},{value:"OMNIBUS CONFIG README",id:"omnibus-config-readme",level:2},{value:"Nginx",id:"nginx",level:3},{value:"Config file",id:"config-file",level:4},{value:"Server block custom_gitlab_server_config.conf",id:"server-block-custom_gitlab_server_configconf",level:4},{value:"Allow/deny access",id:"allowdeny-access",level:4},{value:"Instance access settings",id:"instance-access-settings",level:4},{value:"Instance settings",id:"instance-settings",level:3},{value:"Backup settings",id:"backup-settings",level:3},{value:"Info and References",id:"info-and-references",level:3}],f={toc:u};function d(e){var t=e.components,n=(0,r.Z)(e,o);return(0,l.kt)("wrapper",(0,a.Z)({},f,n,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("h2",{id:"commands"},"Commands"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"service gitlab restart\ngitlab-ctl reconfigure\ngitlab-ctl start\ngitlab-ctl stop\n")),(0,l.kt)("h2",{id:"installation"},"Installation"),(0,l.kt)("h3",{id:"os"},"OS"),(0,l.kt)("p",null,"The recommended operating system is ",(0,l.kt)("inlineCode",{parentName:"p"},"Linux Debian 10 (buster)")," distribution."),(0,l.kt)("h3",{id:"prerequisites"},"Prerequisites"),(0,l.kt)("p",null,"Install required packages:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"apt-get update && \\\n    apt-get install \\\n    cron \\\n    curl \\\n    ca-certificates \\\n    openssh-server \\\n    wget \\\n    apt-transport-https \\\n    vim \\\n    tzdata \\\n    nano \\\n    less \\\n    net-tools\n")),(0,l.kt)("p",null,"Enable SSH and modify key ",(0,l.kt)("inlineCode",{parentName:"p"},"PermitRootLogin yes"),":"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"nano /etc/ssh/sshd_config\n")),(0,l.kt)("p",null,"Restart SSH service for changes to take effect:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"service sshd restart\n")),(0,l.kt)("h3",{id:"installer"},"Installer"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("a",{parentName:"p",href:"https://packages.gitlab.com/gitlab/gitlab-ee"},"GitLab-ee"))),(0,l.kt)("p",null,"Install package:"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-shell"},"sudo dpkg -i gitlab-ee_xx.x.x-ee.0_amd64.deb\n")),(0,l.kt)("h3",{id:"ssh-files"},"SSH files"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"/etc/ssh")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},(0,l.kt)("a",{parentName:"p",href:"https://superuser.com/questions/532040/copy-ssh-keys-from-one-server-to-another-server/532079#532079"},"Copy SSH keys from one server to another server"))),(0,l.kt)("h2",{id:"config-template"},(0,l.kt)("a",{parentName:"h2",href:"https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/files/gitlab-config-template/gitlab.rb.template",title:"gitlab.rb.template"},"CONFIG TEMPLATE")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"/etc/gitlab.rb")),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"Stop GitLab services by executing ",(0,l.kt)("inlineCode",{parentName:"p"},"gitlab-ctl stop")," command before making and saving changes.\\\nExecute ",(0,l.kt)("inlineCode",{parentName:"p"},"gitlab-ctl reconfigre")," command to commit changes.")),(0,l.kt)("h2",{id:"omnibus-config-readme"},(0,l.kt)("a",{parentName:"h2",href:"https://gitlab.com/gitlab-org/omnibus-gitlab/blob/master/README.md"},"OMNIBUS CONFIG README")),(0,l.kt)("h3",{id:"nginx"},"Nginx"),(0,l.kt)("h4",{id:"config-file"},"Config file"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"/var/opt/gitlab/nginx/conf/nginx.conf")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ascii"},"nginx['custom_nginx_config'] = \"include /etc/nginx/conf.d/*.conf;\"\n")),(0,l.kt)("h4",{id:"server-block-custom_gitlab_server_configconf"},"Server block ",(0,l.kt)("a",{parentName:"h4",href:"https://docs.gitlab.com/omnibus/settings/nginx.html#inserting-custom-nginx-settings-into-the-gitlab-server-block",title:"Insert Custom Nginx settings to GitLab server block"},"custom_gitlab_server_config.conf")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ascii"},"nginx['custom_gitlab_server_config'] = \"include /etc/gitlab/custom_gitlab_server_config.conf;\"\nnginx['custom_gitlab_server_config'] = \"location ^~ /foo-namespace/bar-project/raw/ {\\n deny all;\\n}\\n\"\n")),(0,l.kt)("h4",{id:"allowdeny-access"},"Allow/deny access"),(0,l.kt)("blockquote",null,(0,l.kt)("p",{parentName:"blockquote"},"/var/opt/gitlab/nginx/conf/gitlab-http.conf")),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ascii"},"allow 192.168.1.1/24;\ndeny all;\n\nlocation ~ /.well-known {\n    allow all;\n}\n")),(0,l.kt)("h4",{id:"instance-access-settings"},"Instance access settings"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ascii"},"external_url 'hostname'\nnginx['listen_port'] = 80\nnginx['redirect_http_to_https'] = false\nnginx['listen_https'] = false\ngitlab_rails['gitlab_shell_ssh_port'] = 22\n")),(0,l.kt)("h3",{id:"instance-settings"},"Instance settings"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ascii"},"redis['tcp_keepalive'] = '300'\nnginx['gzip_enabled'] = true\ngitlab_rails['gitlab_default_projects_features_builds'] = false\n")),(0,l.kt)("h3",{id:"backup-settings"},"Backup settings"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-ascii"},"gitlab_rails['backup_archive_permissions'] = 0644\ngitlab_rails['backup_path'] = '/var/opt/gitlab/backups'\ngitlab_rails['backup_upload_connection'] = {\n :provider => 'Local',\n :local_root => '/var/backups'\n}\ngitlab_rails['backup_upload_remote_directory'] = '.'\ngitlab_rails['backup_keep_time'] = 604800\n")),(0,l.kt)("p",null,(0,l.kt)("inlineCode",{parentName:"p"},"backup_upload_remote_directory")," ",(0,l.kt)("sup",{parentName:"p",id:"fnref-1"},(0,l.kt)("a",{parentName:"sup",href:"#fn-1",className:"footnote-ref"},"1")),"\\\n",(0,l.kt)("inlineCode",{parentName:"p"},"backup_keep_time")," ",(0,l.kt)("sup",{parentName:"p",id:"fnref-2"},(0,l.kt)("a",{parentName:"sup",href:"#fn-2",className:"footnote-ref"},"2")),"\\\n",(0,l.kt)("inlineCode",{parentName:"p"},"manage_backup_path")," ",(0,l.kt)("sup",{parentName:"p",id:"fnref-3"},(0,l.kt)("a",{parentName:"sup",href:"#fn-3",className:"footnote-ref"},"3")),"\\\n",(0,l.kt)("inlineCode",{parentName:"p"},"gitlab_default_projects_features_builds")," ",(0,l.kt)("sup",{parentName:"p",id:"fnref-4"},(0,l.kt)("a",{parentName:"sup",href:"#fn-4",className:"footnote-ref"},"4"))),(0,l.kt)("h3",{id:"info-and-references"},"Info and References"),(0,l.kt)("div",{className:"footnotes"},(0,l.kt)("hr",{parentName:"div"}),(0,l.kt)("ol",{parentName:"div"},(0,l.kt)("li",{parentName:"ol",id:"fn-1"},"Sub-directory local_root or use . for root.",(0,l.kt)("a",{parentName:"li",href:"#fnref-1",className:"footnote-backref"},"\u21a9")),(0,l.kt)("li",{parentName:"ol",id:"fn-2"},"Limit backup lifetime to 7 days - 604800 seconds.",(0,l.kt)("a",{parentName:"li",href:"#fnref-2",className:"footnote-backref"},"\u21a9")),(0,l.kt)("li",{parentName:"ol",id:"fn-3"},"When modifying ",(0,l.kt)("inlineCode",{parentName:"li"},"backup_path"),", set ",(0,l.kt)("inlineCode",{parentName:"li"},"manage_backup_path")," configuration to ",(0,l.kt)("inlineCode",{parentName:"li"},"false"),".",(0,l.kt)("a",{parentName:"li",href:"#fnref-3",className:"footnote-backref"},"\u21a9")),(0,l.kt)("li",{parentName:"ol",id:"fn-4"},"Disable CI/CD site-wide.",(0,l.kt)("a",{parentName:"li",href:"#fnref-4",className:"footnote-backref"},"\u21a9")))))}d.isMDXComponent=!0}}]);